<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Berlin Bar Tycoon - Fixed</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { background-color: #1a1a1a; color: white; overflow: hidden; }
        #map { height: 100vh; width: 100vw; z-index: 0; background-color: #000; }
        
        .bar-marker-container {
            position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .bar-marker {
            transition: all 0.3s ease; border-radius: 50%; border: 2px solid white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center;
            font-size: 16px; width: 30px; height: 30px; background-color: #333; z-index: 10;
        }
        
        .marker-locked { background-color: #ef4444; opacity: 0.8; }
        .marker-owned { background-color: #22c55e; border-color: #86efac; }
        .marker-affordable-base { background-color: #eab308; }

        .upgrade-arrow {
            position: absolute; top: -30px; left: 50%; transform: translateX(-50%);
            color: #4ade80; font-size: 24px; font-weight: bold; animation: bounce 1s infinite;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8); z-index: 100; cursor: pointer;
            pointer-events: auto !important; filter: drop-shadow(0 0 2px black);
        }
        .upgrade-arrow:hover { transform: translateX(-50%) scale(1.2); color: #22c55e; }

        .income-badge {
            position: absolute; bottom: -18px; background-color: rgba(0, 0, 0, 0.8);
            color: #4ade80; font-size: 10px; padding: 1px 4px; border-radius: 4px;
            white-space: nowrap; font-weight: bold; border: 1px solid #22c55e; z-index: 20; pointer-events: none;
        }

        .level-badge {
            position: absolute; top: -5px; right: -5px; width: 16px; height: 16px;
            background-color: #374151; color: white; border: 1px solid white;
            border-radius: 50%; font-size: 9px; font-weight: bold; display: flex;
            align-items: center; justify-content: center; z-index: 25;
            box-shadow: 0 2px 4px rgba(0,0,0,0.5); transition: all 0.5s ease;
        }

        .level-tier-1 { background-color: #fbbf24; color: black; border-color: #f59e0b; box-shadow: 0 0 8px rgba(251, 191, 36, 0.6); animation: pulse-gold 3s infinite; }
        .level-tier-2 { background-color: #22d3ee; color: black; border-color: #06b6d4; box-shadow: 0 0 10px rgba(34, 211, 238, 0.6); animation: pulse-cyan 3s infinite; }
        .level-tier-3 { background-color: #d8b4fe; color: black; border-color: #a855f7; box-shadow: 0 0 12px rgba(168, 85, 247, 0.8); animation: pulse-purple 2s infinite; }

        @keyframes pulse-gold { 50% { box-shadow: 0 0 15px rgba(251, 191, 36, 0.4); } }
        @keyframes pulse-cyan { 50% { box-shadow: 0 0 15px rgba(34, 211, 238, 0.4); } }
        @keyframes pulse-purple { 50% { box-shadow: 0 0 20px rgba(168, 85, 247, 0.5); } }

        .float-text {
            position: absolute; top: -40px; left: 50%; transform: translateX(-50%);
            color: #ffffff; font-weight: bold; font-size: 14px; text-shadow: 0 2px 4px rgba(0,0,0,1);
            animation: floatUp 1s forwards; pointer-events: none; z-index: 200; white-space: nowrap;
        }

        .money-particle {
            position: absolute; color: #4ade80; font-weight: bold; font-size: 10px;
            pointer-events: none; z-index: 10; opacity: 0; animation: floatUpParticle 4s linear;
        }

        @keyframes floatUpParticle {
            0% { opacity: 0; transform: translateY(0) scale(0.5); } 20% { opacity: 0.8; transform: translateY(-10px) scale(1); } 80% { opacity: 0.8; } 100% { opacity: 0; transform: translateY(-40px) scale(1.2); }
        }
        @keyframes floatUp { 0% { opacity: 1; transform: translateX(-50%) translateY(0); } 100% { opacity: 0; transform: translateX(-50%) translateY(-30px); } }
        @keyframes bounce { 0%, 100% { transform: translateX(-50%) translateY(0); } 50% { transform: translateX(-50%) translateY(-8px); } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .animate-slide-up { animation: slideUp 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }

        .confetti-piece { position: absolute; width: 10px; height: 10px; background: #ffd700; top: -10px; animation: confetti 3s linear forwards; }
        @keyframes confetti { 0% { transform: translateY(0) rotate(0deg); opacity: 1; } 100% { transform: translateY(100vh) rotate(720deg); opacity: 0; } }

        .scout-label {
            background: rgba(0,0,0,0.85); border: 1px solid #eab308; color: #fbbf24;
            padding: 2px 5px; border-radius: 4px; font-size: 10px; font-weight: bold; white-space: nowrap;
            box-shadow: 0 2px 4px black;
        }

        #fog-canvas {
            position: absolute; top: 0; left: 0; pointer-events: none; z-index: 400;
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 3px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, useCallback } = React;

        // --- MATH HELPERS ---
        const getDistanceMeters = (lat1, lon1, lat2, lon2) => {
            const R = 6371e3; 
            const œÜ1 = lat1 * Math.PI/180;
            const œÜ2 = lat2 * Math.PI/180;
            const ŒîœÜ = (lat2-lat1) * Math.PI/180;
            const ŒîŒª = (lon2-lon1) * Math.PI/180;
            const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) + Math.cos(œÜ1) * Math.cos(œÜ2) * Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        };

        // --- DATA: BARS ---
        const INITIAL_BARS = [
            { id: 1, district: "Neuk√∂lln", name: "Das √ñ", lat: 52.4808, lng: 13.4261, baseCost: 100, baseIncome: 1, type: "Kneipe", description: "Urig. Tischkicker. Billiges Bier." },
            { id: 2, district: "Neuk√∂lln", name: "Flunker-Kranich", lat: 52.4825, lng: 13.4330, baseCost: 500, baseIncome: 4, type: "Rooftop", description: "Sonnenuntergang √ºber den Arcaden." },
            { id: 21, district: "Neuk√∂lln", name: "Rixdorf Lounge", lat: 52.4730, lng: 13.4450, baseCost: 750, baseIncome: 6, type: "Lounge", description: "Versteckt im b√∂hmischen Dorf." },
            { id: 22, district: "Neuk√∂lln", name: "Tempelhofer Feld", lat: 52.4720, lng: 13.4150, baseCost: 1500, baseIncome: 12, type: "OpenAir", description: "Bier auf der Landebahn." },
            { id: 3, district: "Kreuzberg", name: "Club der Illusion√§re", lat: 52.4965, lng: 13.4520, baseCost: 1200, baseIncome: 10, type: "Outdoor", description: "Tanzen am Flutgraben." },
            { id: 4, district: "Kreuzberg", name: "Pink Palace", lat: 52.4975, lng: 13.4185, baseCost: 2500, baseIncome: 25, type: "Kult", description: "Pl√ºschig, pink und legend√§r." },
            { id: 8, district: "Kreuzberg", name: "Floodgate", lat: 52.5008, lng: 13.4445, baseCost: 45000, baseIncome: 350, type: "Club", description: "LED-Decke an der Spree." },
            { id: 11, district: "Kreuzberg", name: "Prince Charles", lat: 52.5036, lng: 13.4077, baseCost: 15000, baseIncome: 120, type: "Club", description: "Hip Hop und Burger im Pool." },
            { id: 9, district: "Friedrichshain", name: "Bergheim", lat: 52.5113, lng: 13.4433, baseCost: 100000, baseIncome: 800, type: "Legend√§r", description: "Die h√§rteste T√ºr der Welt." },
            { id: 12, district: "Friedrichshain", name: "Tante Renate", lat: 52.4976, lng: 13.4658, baseCost: 30000, baseIncome: 210, type: "Club", description: "Ein Haus voller wirrer Partys." },
            { id: 13, district: "Friedrichshain", name: "The Grid", lat: 52.5028, lng: 13.4475, baseCost: 60000, baseIncome: 450, type: "Tourist", description: "Jeder Schulausflug endet hier." },
            { id: 14, district: "Friedrichshain", name: "Star Club", lat: 52.5085, lng: 13.4542, baseCost: 8000, baseIncome: 60, type: "Kultur", description: "Kino, Klettern, Punkrock." },
            { id: 6, district: "Mitte", name: "Der Safe", lat: 52.5106, lng: 13.4194, baseCost: 10000, baseIncome: 90, type: "Techno", description: "Der Urvater des Berliner Techno." },
            { id: 10, district: "Mitte", name: "KittyKat", lat: 52.5126, lng: 13.4165, baseCost: 250000, baseIncome: 1500, type: "Legend√§r", description: "Hier fallen alle H√ºllen." },
            { id: 15, district: "Mitte", name: "King Kong Bar", lat: 52.5255, lng: 13.4124, baseCost: 3500, baseIncome: 30, type: "Bar", description: "Schick in der Brunnenstra√üe." },
            { id: 16, district: "Mitte", name: "Permament Vacation", lat: 52.5220, lng: 13.3880, baseCost: 7000, baseIncome: 55, type: "Politik", description: "Wo Politiker K√∂lsch trinken." },
            { id: 23, district: "Mitte", name: "TV Tower Bar", lat: 52.5208, lng: 13.4094, baseCost: 20000, baseIncome: 180, type: "View", description: "Ganz oben in der Kugel." },
            { id: 7, district: "Prenzlauer Berg", name: "Panke Garten", lat: 52.5404, lng: 13.4107, baseCost: 20000, baseIncome: 180, type: "Biergarten", description: "Berlins √§ltester Biergarten." },
            { id: 17, district: "Prenzlauer Berg", name: "Culture Brewery", lat: 52.5390, lng: 13.4132, baseCost: 25000, baseIncome: 190, type: "Areal", description: "Riesiges Areal, viele Clubs." },
            { id: 24, district: "Prenzlauer Berg", name: "Mauerpark Karaoke", lat: 52.5440, lng: 13.4030, baseCost: 2500, baseIncome: 20, type: "OpenAir", description: "Sonntags singen vor tausenden." },
            { id: 25, district: "Prenzlauer Berg", name: "Wasserturm", lat: 52.5330, lng: 13.4200, baseCost: 8000, baseIncome: 65, type: "Kiez", description: "Rund um den Turm." },
            { id: 5, district: "Charlottenburg", name: "Ape Lounge", lat: 52.5053, lng: 13.3364, baseCost: 5000, baseIncome: 45, type: "Chic", description: "Teure Drinks, Blick auf Affen." },
            { id: 18, district: "Charlottenburg", name: "Dunkles Caf√©", lat: 52.5065, lng: 13.3200, baseCost: 4000, baseIncome: 35, type: "24h", description: "Hat eigentlich immer offen." },
            { id: 26, district: "Charlottenburg", name: "Schlossgarten", lat: 52.5200, lng: 13.2950, baseCost: 12000, baseIncome: 95, type: "Royal", description: "Feiern wie ein K√∂nig." },
            { id: 27, district: "Charlottenburg", name: "Ku'damm Beach", lat: 52.4980, lng: 13.2800, baseCost: 30000, baseIncome: 220, type: "Luxus", description: "Champagner am Halensee." },
            { id: 19, district: "Lichtenberg", name: "Sisyphus Hill", lat: 52.4930, lng: 13.4910, baseCost: 80000, baseIncome: 650, type: "OpenAir", description: "Feiern von Freitag bis Montag." },
            { id: 28, district: "Lichtenberg", name: "Dong Xuan Center", lat: 52.5350, lng: 13.4850, baseCost: 5000, baseIncome: 40, type: "Markt", description: "Geheimtipps in Halle 8." },
            { id: 29, district: "Lichtenberg", name: "Rummels Bucht", lat: 52.4970, lng: 13.4800, baseCost: 18000, baseIncome: 130, type: "Piraten", description: "Versteckt am Ufer." },
            { id: 20, district: "Treptow", name: "Molecule Man", lat: 52.4967, lng: 13.4593, baseCost: 500000, baseIncome: 2500, type: "Landmark", description: "Party auf dem Wasser." },
            { id: 30, district: "Treptow", name: "Island of Youth", lat: 52.4850, lng: 13.4750, baseCost: 10000, baseIncome: 85, type: "Insel", description: "Abh√§ngen auf der Br√ºcke." },
            { id: 31, district: "Treptow", name: "Arena Badeschiff", lat: 52.5000, lng: 13.4530, baseCost: 60000, baseIncome: 420, type: "Sommer", description: "Pool in der Spree." }
        ];

        const BASE_ACHIEVEMENTS = [
            { id: 'first_buck', name: 'Erster Euro', description: 'Besitze 1‚Ç¨', condition: (state) => state.money >= 1, reward: 0 },
            { id: 'bar_owner', name: 'Kneipier', description: 'Kaufe deine erste Bar', condition: (state, bars) => Object.values(bars).some(b => b.owned), reward: 1.1 },
            { id: 'millionaire', name: 'Million√§r', description: 'Besitze 1.000.000‚Ç¨', condition: (state) => state.money >= 1000000, reward: 1.5 },
            { id: 'bottle_master', name: 'Pfand Profi', description: 'Erreiche Sammel-Level 5', condition: (state) => state.clickLevel >= 5, reward: 1.2 },
            { id: 'click_100', name: 'Finger-Training', description: 'Klicke 100 mal', condition: (state) => state.totalClicks >= 100, reward: 1.1 },
            { id: 'click_500', name: 'Maus-Zerst√∂rer', description: 'Klicke 500 mal', condition: (state) => state.totalClicks >= 500, reward: 1.2 },
            { id: 'click_1000', name: 'Lichtgeschwindigkeit', description: 'Klicke 1000 mal', condition: (state) => state.totalClicks >= 1000, reward: 1.3 },
        ];

        const ALL_ACHIEVEMENTS = [...BASE_ACHIEVEMENTS];

        const formatMoney = (amount) => {
            if (amount >= 1000000) return (amount / 1000000).toFixed(2).replace('.', ',') + ' Mio. ‚Ç¨';
            if (amount >= 1000) return (amount / 1000).toFixed(1).replace('.', ',') + 'k ‚Ç¨';
            return new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }).format(amount);
        };

        const formatShortMoney = (amount) => {
             if (amount >= 1000000) return (amount / 1000000).toFixed(1) + 'M';
             if (amount >= 1000) return (amount / 1000).toFixed(1) + 'k';
             return Math.floor(amount);
        }

        const formatDistance = (meters) => {
            if (meters >= 1000) return (meters / 1000).toFixed(1) + ' km';
            return Math.round(meters) + ' m';
        };

        const App = () => {
            const [gameState, setGameState] = useState(() => {
                const saved = localStorage.getItem('berlinBarTycoon_v13'); 
                const defaultState = {
                    money: 0, clickLevel: 1, totalClicks: 0, unlockedAchievements: [], bars: {}, hasSeenWin: false
                };
                INITIAL_BARS.forEach(bar => { defaultState.bars[bar.id] = { level: 0, owned: false, rangeLevel: 1 }; });
                if (saved) {
                    const parsed = JSON.parse(saved);
                    const mergedBars = { ...defaultState.bars };
                    Object.keys(parsed.bars).forEach(id => {
                        mergedBars[id] = { ...defaultState.bars[id], ...parsed.bars[id] };
                        if (!mergedBars[id].rangeLevel) mergedBars[id].rangeLevel = 1;
                    });
                    return { ...defaultState, ...parsed, bars: mergedBars };
                }
                return defaultState;
            });

            // Territory State
            const [territoryState, setTerritoryState] = useState({ points: [], bonus: 1.0 });

            const [selectedBarId, setSelectedBarId] = useState(null);
            const [isListOpen, setIsListOpen] = useState(false);
            const [showAchievements, setShowAchievements] = useState(false);
            const [showWinModal, setShowWinModal] = useState(false);
            const [notification, setNotification] = useState(null);
            
            // MOVED UP: Definitions that were causing ReferenceError
            const selectedBar = selectedBarId ? INITIAL_BARS.find(b => b.id === selectedBarId) : null;
            const selectedBarState = selectedBarId ? gameState.bars[selectedBarId] : null;

            const mapRef = useRef(null);
            const markersRef = useRef({});
            const scoutLinesRef = useRef([]);
            const canvasRef = useRef(null); 

            // --- CALCULATIONS ---
            const getGlobalMultiplier = () => {
                let multiplier = 1;
                gameState.unlockedAchievements.forEach(achId => {
                    const ach = ALL_ACHIEVEMENTS.find(a => a.id === achId);
                    if (ach && ach.reward > 0) multiplier *= ach.reward;
                });
                return multiplier;
            };

            const globalMult = useMemo(() => getGlobalMultiplier(), [gameState.unlockedAchievements]);

            const getIncome = (barId) => {
                const bar = INITIAL_BARS.find(b => b.id === barId);
                const state = gameState.bars[barId];
                if (!state || !state.owned) return 0;
                const milestonesPassed = Math.floor(state.level / 5);
                return bar.baseIncome * state.level * globalMult * Math.pow(2, milestonesPassed);
            };

            const getTotalIncome = () => {
                return INITIAL_BARS.reduce((sum, bar) => sum + getIncome(bar.id), 0);
            };

            const getUpgradeCost = (barId) => {
                const bar = INITIAL_BARS.find(b => b.id === barId);
                const state = gameState.bars[barId];
                if (!state || !state.owned) return bar.baseCost;
                return Math.floor(bar.baseCost * Math.pow(1.5, state.level));
            };

            const getRangeRadius = (barId) => {
                const state = gameState.bars[barId];
                if (!state.owned && barId !== 1) return 0;
                if (barId === 1 && !state.owned) return 600; 
                return 500 + ((state.rangeLevel - 1) * 200);
            };

            const getRangeUpgradeCost = (barId) => {
                const state = gameState.bars[barId];
                return Math.floor(1000 * Math.pow(1.8, state.rangeLevel - 1));
            };

            const getClickIncome = () => {
                const base = (10 * Math.pow(1.8, gameState.clickLevel - 1)) + (getTotalIncome() * 0.05);
                return base * globalMult * 4; 
            };

            const getClickUpgradeCost = () => {
                return Math.floor(500 * Math.pow(2.5, gameState.clickLevel - 1));
            };

            const isBarVisible = (targetBar) => {
                const targetLat = targetBar.lat;
                const targetLng = targetBar.lng;
                if (gameState.bars[targetBar.id].owned) return true;
                if (targetBar.id === 1) return true;

                for (const sourceBar of INITIAL_BARS) {
                    const radius = getRangeRadius(sourceBar.id);
                    if (radius > 0) {
                        const dist = getDistanceMeters(sourceBar.lat, sourceBar.lng, targetLat, targetLng);
                        if (dist <= radius) return true;
                    }
                }
                return false;
            };

            const canAffordAnyUpgrade = useMemo(() => {
                return INITIAL_BARS.some(bar => isBarVisible(bar) && (gameState.money >= getUpgradeCost(bar.id) || gameState.money >= getRangeUpgradeCost(bar.id)));
            }, [gameState.money, gameState.bars]);

            // --- CANVAS FOG DRAWING ---
            const drawFog = useCallback(() => {
                if (!mapRef.current || !canvasRef.current) return;
                
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                const map = mapRef.current;
                const size = map.getSize();
                
                if (canvas.width !== size.x || canvas.height !== size.y) {
                    canvas.width = size.x;
                    canvas.height = size.y;
                }
                
                ctx.globalCompositeOperation = 'source-over';
                ctx.fillStyle = '#000000';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                ctx.globalCompositeOperation = 'destination-out';
                ctx.fillStyle = '#ffffff';

                INITIAL_BARS.forEach(bar => {
                    const radiusMeters = getRangeRadius(bar.id);
                    if (radiusMeters > 0) {
                        const center = map.latLngToContainerPoint([bar.lat, bar.lng]);
                        // Fix for radius stability: calc based on latitude
                        const latRad = bar.lat * Math.PI / 180;
                        const metersPerPixel = 156543.03392 * Math.cos(latRad) / Math.pow(2, map.getZoom());
                        const radiusPx = radiusMeters / metersPerPixel;

                        ctx.beginPath();
                        ctx.arc(center.x, center.y, radiusPx, 0, Math.PI * 2);
                        ctx.fill();
                    }
                });
            }, [gameState.bars]); 

            // --- INITIALIZATION ---
            useEffect(() => {
                if (!mapRef.current) {
                    // Init Map ONLY ONCE
                    mapRef.current = L.map('map', { zoomControl: false, attributionControl: false }).setView([52.4808, 13.4261], 14);
                    
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; OpenStreetMap contributors',
                        maxZoom: 19
                    }).addTo(mapRef.current);

                    const canvas = document.createElement('canvas');
                    canvas.id = 'fog-canvas';
                    mapRef.current.getContainer().appendChild(canvas);
                    canvasRef.current = canvas;
                }

                const map = mapRef.current;

                // Re-bind events to current drawFog closure
                map.off('move', drawFog);
                map.off('zoom', drawFog);
                map.off('resize', drawFog);
                map.off('viewreset', drawFog);

                map.on('move', drawFog);
                map.on('zoom', drawFog);
                map.on('resize', drawFog);
                map.on('viewreset', drawFog);

                // Force draw
                drawFog();

                return () => {
                    map.off('move', drawFog);
                    map.off('zoom', drawFog);
                    map.off('resize', drawFog);
                    map.off('viewreset', drawFog);
                };
            }, [drawFog]); // Only re-run if drawFog changes (which depends on bars state)

            // --- LOOPS & OTHER EFFECTS ---
            useEffect(() => {
                const interval = setInterval(() => {
                    const income = getTotalIncome();
                    if (income > 0) setGameState(prev => ({ ...prev, money: prev.money + income }));
                }, 1000);
                return () => clearInterval(interval);
            }, [gameState.bars, gameState.unlockedAchievements]);

            useEffect(() => {
                localStorage.setItem('berlinBarTycoon_v13', JSON.stringify(gameState));
            }, [gameState]);

            useEffect(() => {
                if (gameState.money >= 1000000 && !gameState.hasSeenWin) {
                    setShowWinModal(true);
                    setGameState(prev => ({ ...prev, hasSeenWin: true }));
                }
            }, [gameState.money]);

            // Achievements
            useEffect(() => {
                const newUnlocks = [];
                ALL_ACHIEVEMENTS.forEach(ach => {
                    if (!gameState.unlockedAchievements.includes(ach.id)) {
                        if (ach.condition(gameState, gameState.bars)) {
                            newUnlocks.push(ach);
                        }
                    }
                });
                if (newUnlocks.length > 0) {
                    setGameState(prev => ({
                        ...prev,
                        unlockedAchievements: [...prev.unlockedAchievements, ...newUnlocks.map(u => u.id)]
                    }));
                    setNotification({
                        title: "üèÜ Erfolg freigeschaltet!",
                        message: `${newUnlocks[0].name}: ${newUnlocks[0].description}`
                    });
                    setTimeout(() => setNotification(null), 4000);
                }
            }, [gameState.money, gameState.bars, gameState.clickLevel, gameState.totalClicks]);

            // Markers & Lines Update
            useEffect(() => {
                if(!mapRef.current) return;
                const map = mapRef.current;

                // --- SCOUT ARROWS ---
                scoutLinesRef.current.forEach(l => {
                    if(l.line) l.line.remove();
                    if(l.tip) l.tip.remove();
                });
                scoutLinesRef.current = [];

                const visibleBarIds = new Set(INITIAL_BARS.filter(b => isBarVisible(b)).map(b => b.id));
                const hiddenBars = INITIAL_BARS.filter(b => !visibleBarIds.has(b.id));

                if (hiddenBars.length > 0) {
                    INITIAL_BARS.forEach(sourceBar => {
                        if (gameState.bars[sourceBar.id].owned) {
                            let nearest = null;
                            let minDistance = Infinity;

                            hiddenBars.forEach(target => {
                                const d = getDistanceMeters(sourceBar.lat, sourceBar.lng, target.lat, target.lng);
                                if (d < minDistance) {
                                    minDistance = d;
                                    nearest = target;
                                }
                            });

                            if (nearest) {
                                const line = L.polyline([[sourceBar.lat, sourceBar.lng], [nearest.lat, nearest.lng]], {
                                    color: '#eab308', // Yellow
                                    dashArray: '8, 8',
                                    weight: 4, // Thicker
                                    opacity: 0.9,
                                    className: 'animate-pulse'
                                }).addTo(map);
                                
                                // Label closer to source
                                const lat = sourceBar.lat + (nearest.lat - sourceBar.lat) * 0.15; // Closer to start (15%)
                                const lng = sourceBar.lng + (nearest.lng - sourceBar.lng) * 0.15;

                                const tooltip = L.tooltip({
                                    permanent: true, direction: 'center', className: 'scout-label', offset: [0, 0]
                                })
                                .setLatLng([lat, lng])
                                .setContent(`‚û° ${formatDistance(minDistance)}`)
                                .addTo(map);
                                
                                scoutLinesRef.current.push({line, tip: tooltip});
                            }
                        }
                    });
                }

                // --- MARKERS ---
                INITIAL_BARS.forEach(bar => {
                    const isVisible = isBarVisible(bar);
                    const state = gameState.bars[bar.id] || { owned: false };
                    
                    if (!isVisible) {
                        if (markersRef.current[bar.id]) {
                            markersRef.current[bar.id].remove();
                            delete markersRef.current[bar.id];
                        }
                        return;
                    }

                    const cost = getUpgradeCost(bar.id);
                    const isAffordable = gameState.money >= cost;
                    const income = getIncome(bar.id);
                    
                    let markerClass = 'bar-marker';
                    if (state.owned) markerClass += ' marker-owned';
                    else if (isAffordable) markerClass += ' marker-affordable-base';
                    else markerClass += ' marker-locked';

                    let levelBadgeHtml = '';
                    if (state.owned && state.level > 0) {
                        let badgeClass = 'level-badge';
                        if (state.level >= 25) badgeClass += ' level-tier-3';
                        else if (state.level >= 10) badgeClass += ' level-tier-2';
                        else if (state.level >= 5) badgeClass += ' level-tier-1';
                        levelBadgeHtml = `<div class="${badgeClass}">${state.level}</div>`;
                    }

                    // Define global trigger if needed, or handle differently. 
                    // Using window for simplicity in leaflet html
                    window[`triggerUpgrade_${bar.id}`] = (e) => {
                        if(e) e.stopPropagation();
                        purchaseOrUpgradeBar(bar.id, true);
                    };

                    const arrowHtml = isAffordable 
                        ? `<div class="upgrade-arrow" onclick="window.triggerUpgrade_${bar.id}(event)" title="Direkt kaufen/upgraden">‚¨ÜÔ∏è</div>` : '';

                    const iconHtml = `
                        <div class="bar-marker-container">
                            ${arrowHtml}
                            <div class="${markerClass}">${state.owned ? 'üçª' : 'üîí'}</div>
                            ${levelBadgeHtml}
                            ${state.owned && income > 0 ? `<div class="income-badge">${formatShortMoney(income)}/s</div>` : ''}
                        </div>
                    `;

                    const customIcon = L.divIcon({ className: 'custom-leaflet-icon', html: iconHtml, iconSize: [30, 30], iconAnchor: [15, 15] });

                    if (!markersRef.current[bar.id]) {
                        const marker = L.marker([bar.lat, bar.lng], { icon: customIcon })
                            .addTo(map)
                            .on('click', () => {
                                setSelectedBarId(bar.id);
                                map.setView([bar.lat + 0.002, bar.lng], 15);
                                setIsListOpen(false);
                            });
                        markersRef.current[bar.id] = marker;
                    } else {
                        markersRef.current[bar.id].setIcon(customIcon);
                        if (isAffordable) markersRef.current[bar.id].setZIndexOffset(1000);
                        else markersRef.current[bar.id].setZIndexOffset(0);
                    }
                });

            }, [gameState.bars, gameState.money]); 


            // --- ACTIONS ---
            const handleClicker = () => {
                setGameState(prev => ({ 
                    ...prev, 
                    money: prev.money + getClickIncome(),
                    totalClicks: (prev.totalClicks || 0) + 1 
                }));
            };

            const upgradeClicker = () => {
                const cost = getClickUpgradeCost();
                if (gameState.money >= cost) setGameState(prev => ({ ...prev, money: prev.money - cost, clickLevel: prev.clickLevel + 1 }));
            };

            const purchaseOrUpgradeBar = (barId, fromMap = false) => {
                setGameState(prev => {
                    const bar = INITIAL_BARS.find(b => b.id === barId);
                    const state = prev.bars[barId];
                    const currentLevel = state ? state.level : 0;
                    const isOwned = state ? state.owned : false;
                    const cost = !isOwned ? bar.baseCost : Math.floor(bar.baseCost * Math.pow(1.5, currentLevel));
                    
                    if (prev.money >= cost) {
                        if (fromMap) {
                            showFloatingText(bar.id, isOwned ? `Lvl ${currentLevel + 1}` : "Gekauft!");
                        }
                        const newState = { ...prev, money: prev.money - cost, bars: { ...prev.bars } };
                        newState.bars[barId] = { ...prev.bars[barId] };
                        if (!newState.bars[barId].owned) {
                            newState.bars[barId].owned = true;
                            newState.bars[barId].level = 1;
                        } else {
                            newState.bars[barId].level += 1;
                        }
                        return newState;
                    }
                    return prev;
                });
            };

            const upgradeRange = (barId) => {
                const cost = getRangeUpgradeCost(barId);
                if (gameState.money >= cost) {
                    setGameState(prev => {
                        const newState = { ...prev, money: prev.money - cost, bars: { ...prev.bars } };
                        newState.bars[barId] = { 
                            ...prev.bars[barId],
                            rangeLevel: (prev.bars[barId].rangeLevel || 1) + 1
                        };
                        return newState;
                    });
                }
            };

            const upgradeAll = () => {
                setGameState(prev => {
                    let currentMoney = prev.money;
                    const newBars = { ...prev.bars };
                    let changed = false;
                    
                    // 1. Upgrade Income (Prioritize Owned)
                    INITIAL_BARS.forEach(bar => {
                        if (!isBarVisible(bar)) return;
                        const state = newBars[bar.id];
                        // Prioritize income upgrades for owned bars first
                        if(state.owned) {
                             const cost = Math.floor(bar.baseCost * Math.pow(1.5, state.level));
                             if (currentMoney >= cost) {
                                currentMoney -= cost;
                                newBars[bar.id] = { ...state, level: state.level + 1 };
                                changed = true;
                             }
                        }
                    });
                    
                    // 2. Buy New Bars (if money left)
                    INITIAL_BARS.forEach(bar => {
                        if (!isBarVisible(bar)) return;
                        const state = newBars[bar.id];
                        if(!state.owned) {
                             const cost = bar.baseCost;
                             if (currentMoney >= cost) {
                                currentMoney -= cost;
                                newBars[bar.id] = { ...state, owned: true, level: 1 };
                                changed = true;
                             }
                        }
                    });

                    // 3. Upgrade Visibility (if money left)
                    INITIAL_BARS.forEach(bar => {
                        if (!newBars[bar.id].owned) return;
                        // Use updated state for cost calc if it changed in step 1, but range level didn't change yet
                        const rangeCost = Math.floor(1000 * Math.pow(1.8, newBars[bar.id].rangeLevel - 1));
                        
                        if (currentMoney >= rangeCost) {
                            currentMoney -= rangeCost;
                            newBars[bar.id].rangeLevel += 1;
                            changed = true;
                        }
                    });

                    if (changed) {
                        return { ...prev, money: currentMoney, bars: newBars };
                    }
                    return prev;
                });
            };

            const showFloatingText = (barId, text) => {
                const marker = markersRef.current[barId];
                if (!marker) return;
                const map = mapRef.current;
                const bar = INITIAL_BARS.find(b => b.id === barId);
                const point = map.latLngToContainerPoint([bar.lat, bar.lng]);
                const el = document.createElement('div');
                el.className = 'float-text';
                el.innerText = text;
                el.style.left = point.x + 'px';
                el.style.top = point.y + 'px';
                document.getElementById('map').appendChild(el);
                setTimeout(() => el.remove(), 1000);
            };

             const showMoneyParticle = (barId) => {
                const marker = markersRef.current[barId];
                if (!marker || !mapRef.current) return;
                const map = mapRef.current;
                const bar = INITIAL_BARS.find(b => b.id === barId);
                const point = map.latLngToContainerPoint([bar.lat, bar.lng]);
                const el = document.createElement('div');
                el.className = 'money-particle';
                el.innerText = '‚Ç¨';
                el.style.left = (point.x + (Math.random() * 20 - 10)) + 'px';
                el.style.top = point.y + 'px';
                document.getElementById('map').appendChild(el);
                setTimeout(() => el.remove(), 4000);
            };

            // ADDED: barsByDistrict definition that was missing
            const barsByDistrict = useMemo(() => {
                const groups = {};
                INITIAL_BARS.forEach(bar => {
                    if (isBarVisible(bar)) {
                        if (!groups[bar.district]) groups[bar.district] = [];
                        groups[bar.district].push(bar);
                    }
                });
                return groups;
            }, [gameState.bars]); // Depend on bars state because isBarVisible depends on it (indirectly via owned status/ranges)

            return (
                <div className="relative h-screen w-screen font-sans text-white select-none">
                    <div id="map" className="absolute top-0 left-0 w-full h-full bg-black"></div>

                    {showWinModal && (
                        <div className="absolute inset-0 z-50 bg-black/80 flex items-center justify-center p-4" onClick={() => setShowWinModal(false)}>
                            <div className="absolute inset-0 overflow-hidden pointer-events-none">
                                {[...Array(50)].map((_, i) => (
                                    <div key={i} className="confetti-piece" style={{ left: `${Math.random() * 100}%`, animationDelay: `${Math.random() * 2}s`, backgroundColor: ['#f00', '#0f0', '#00f', '#ff0', '#0ff', '#f0f'][Math.floor(Math.random() * 6)] }}></div>
                                ))}
                            </div>
                            <div className="bg-gray-900 border-4 border-yellow-500 rounded-3xl p-8 text-center shadow-2xl animate-fade-in max-w-lg z-50">
                                <h1 className="text-4xl md:text-6xl font-black text-yellow-500 mb-4 drop-shadow-lg">BERLIN<br/>BAR K√ñNIG!</h1>
                                <p className="text-xl text-gray-300 mb-6">Du hast deine erste Million gemacht!<br/>Die Stadt liegt dir zu F√º√üen.</p>
                                <div className="text-6xl mb-6">üëë</div>
                                <button onClick={(e) => { e.stopPropagation(); setShowWinModal(false); }} className="bg-yellow-600 hover:bg-yellow-500 text-black font-bold text-xl px-8 py-3 rounded-full transition-transform hover:scale-105">Weiterfeiern</button>
                            </div>
                        </div>
                    )}

                    {notification && (
                        <div className="absolute top-24 left-1/2 transform -translate-x-1/2 z-50 bg-yellow-600 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 animate-fade-in border-2 border-yellow-400 w-max max-w-[90vw]">
                            <i data-lucide="trophy" className="w-6 h-6 flex-shrink-0"></i>
                            <div>
                                <div className="font-bold text-sm">{notification.title}</div>
                                <div className="text-xs">{notification.message}</div>
                            </div>
                        </div>
                    )}

                    {/* HUD */}
                    <div className="absolute top-0 left-0 w-full p-4 z-20 pointer-events-none flex justify-between items-start">
                        <div className="flex flex-col gap-2 pointer-events-auto">
                            <div className="bg-gray-900/90 backdrop-blur border border-gray-700 p-4 rounded-xl shadow-2xl min-w-[180px]">
                                <div className="text-gray-400 text-xs uppercase tracking-wider font-bold">Kontostand</div>
                                <div className="text-3xl font-bold text-green-400">{formatMoney(gameState.money)}</div>
                                <div className="text-sm text-gray-300 flex items-center gap-1">
                                    <i data-lucide="trending-up" className="w-4 h-4"></i> 
                                    {formatMoney(getTotalIncome())} / Sek.
                                </div>
                                <div className="flex flex-col gap-0.5 mt-1">
                                    {globalMult > 1 && <div className="text-xs text-yellow-500 font-bold">Multiplikator: x{globalMult.toFixed(2)}</div>}
                                </div>
                            </div>
                            
                            <div className="flex gap-2">
                                <button onClick={() => setIsListOpen(!isListOpen)} className="bg-gray-800 border border-gray-600 text-white p-3 rounded-xl shadow-lg hover:bg-gray-700 active:scale-95 transition-transform flex items-center gap-2">
                                    <span>üìã</span><span className="font-bold text-sm hidden md:inline">{isListOpen ? 'Zu' : 'Liste'}</span>
                                </button>
                                <button onClick={() => setShowAchievements(!showAchievements)} className="bg-gray-800 border border-gray-600 text-white p-3 rounded-xl shadow-lg hover:bg-gray-700 active:scale-95 transition-transform flex items-center gap-2 relative">
                                    <span>üèÜ</span>
                                    {gameState.unlockedAchievements.length > 0 && <span className="absolute -top-1 -right-1 bg-yellow-500 text-black text-[10px] w-5 h-5 rounded-full flex items-center justify-center font-bold">{gameState.unlockedAchievements.length}</span>}
                                </button>
                                
                                <button onClick={upgradeAll} disabled={!canAffordAnyUpgrade} className={`p-3 rounded-xl shadow-lg flex items-center gap-2 transition-transform border ${canAffordAnyUpgrade ? 'bg-blue-600 border-blue-400 hover:bg-blue-500 text-white active:scale-95' : 'bg-gray-800 border-gray-600 text-gray-500 opacity-50 cursor-not-allowed'}`} title="Alles upgraden was m√∂glich ist">
                                    <span className="font-bold">‚ö° Alles</span>
                                </button>
                            </div>
                        </div>

                        <div className="flex flex-col items-end gap-2 pointer-events-auto">
                            <button onClick={handleClicker} className="bg-yellow-500 hover:bg-yellow-400 text-black font-bold p-4 md:p-6 rounded-full shadow-lg transform hover:scale-105 active:scale-95 transition-all border-4 border-yellow-600 group relative overflow-hidden">
                                <div className="flex flex-col items-center relative z-10">
                                    <span className="text-2xl md:text-3xl group-active:animate-bounce">üçæ</span>
                                    <div className="text-xs font-bold mt-1 bg-black/40 px-2 rounded-full border border-yellow-300/30">
                                        +{formatShortMoney(getClickIncome())}
                                    </div>
                                </div>
                                <div className="absolute bottom-0 left-0 w-full h-1 bg-black/20"></div>
                            </button>
                            <button onClick={upgradeClicker} disabled={gameState.money < getClickUpgradeCost()} className={`text-xs font-bold px-3 py-1.5 rounded-lg border flex items-center gap-2 transition-colors ${gameState.money >= getClickUpgradeCost() ? 'bg-blue-600 border-blue-400 hover:bg-blue-500 text-white' : 'bg-gray-800 border-gray-600 text-gray-500 cursor-not-allowed'}`}>
                                <div className="flex flex-col items-end">
                                    <span>Lvl {gameState.clickLevel}</span>
                                    <span>{formatMoney(getClickUpgradeCost())}</span>
                                </div>
                                <span className="text-lg">‚¨ÜÔ∏è</span>
                            </button>
                        </div>
                    </div>

                    {showAchievements && (
                        <div className="absolute inset-0 z-40 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4" onClick={() => setShowAchievements(false)}>
                            <div className="bg-gray-900 border border-gray-600 rounded-2xl w-full max-w-lg max-h-[80vh] overflow-hidden flex flex-col shadow-2xl" onClick={e => e.stopPropagation()}>
                                <div className="p-4 border-b border-gray-700 flex justify-between items-center bg-gray-800">
                                    <h2 className="text-xl font-bold text-yellow-500 flex items-center gap-2">üèÜ Erfolge</h2>
                                    <button onClick={() => setShowAchievements(false)} className="text-gray-400 hover:text-white">‚úï</button>
                                </div>
                                <div className="p-4 overflow-y-auto space-y-3">
                                    {ALL_ACHIEVEMENTS.map(ach => {
                                        const unlocked = gameState.unlockedAchievements.includes(ach.id);
                                        return (
                                            <div key={ach.id} className={`p-3 rounded-xl border flex items-center gap-3 ${unlocked ? 'bg-gray-800 border-yellow-600/50' : 'bg-gray-900/50 border-gray-800 opacity-60'}`}>
                                                <div className={`w-12 h-12 rounded-full flex items-center justify-center text-2xl ${unlocked ? 'bg-yellow-600 text-white' : 'bg-gray-800 text-gray-600'}`}>
                                                    {unlocked ? '‚úì' : '?'}
                                                </div>
                                                <div className="flex-1">
                                                    <div className={`font-bold ${unlocked ? 'text-white' : 'text-gray-500'}`}>{ach.name}</div>
                                                    <div className="text-xs text-gray-400">{ach.description}</div>
                                                </div>
                                                {ach.reward > 0 && <div className="text-xs font-mono text-green-400 bg-green-900/30 px-2 py-1 rounded">x{ach.reward} Boost</div>}
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        </div>
                    )}

                    {selectedBar && (
                        <div className="absolute bottom-0 left-0 right-0 md:left-auto md:right-4 md:bottom-4 md:w-96 md:top-24 z-30 p-4 animate-slide-up pointer-events-none md:pointer-events-auto">
                            <div className="bg-gray-900/95 backdrop-blur border border-gray-700 rounded-xl p-6 text-white shadow-2xl relative pointer-events-auto">
                                <button onClick={() => setSelectedBarId(null)} className="absolute top-2 right-2 text-gray-400 hover:text-white p-2">‚úï</button>
                                <div className="flex items-center gap-3 mb-4">
                                    <div className={`w-12 h-12 rounded-full flex items-center justify-center text-2xl ${selectedBarState.owned ? 'bg-green-600' : 'bg-red-600'}`}>
                                        {selectedBarState.owned ? 'üè¢' : 'üîí'}
                                    </div>
                                    <div>
                                        <div className="text-[10px] text-yellow-500 uppercase font-bold tracking-widest">{selectedBar.district}</div>
                                        <h2 className="text-xl font-bold leading-tight">{selectedBar.name}</h2>
                                        <div className="text-xs text-gray-400 bg-gray-800 px-2 py-0.5 rounded inline-block mt-1">{selectedBar.type}</div>
                                    </div>
                                </div>
                                <p className="text-sm text-gray-300 mb-6 italic border-l-2 border-gray-600 pl-3">"{selectedBar.description}"</p>
                                <div className="grid grid-cols-2 gap-4 mb-6">
                                    <div className="bg-gray-800 p-3 rounded-lg">
                                        <div className="text-xs text-gray-500">Level</div>
                                        <div className="text-xl font-bold text-white flex items-center gap-2">
                                            {selectedBarState.level} 
                                            <span className="text-[10px] bg-yellow-600 text-white px-1.5 py-0.5 rounded">
                                                x{Math.pow(2, Math.floor(selectedBarState.level / 5))} Boost
                                            </span>
                                        </div>
                                    </div>
                                    <div className="bg-gray-800 p-3 rounded-lg">
                                        <div className="text-xs text-gray-500">Einkommen</div>
                                        <div className="text-xl font-bold text-green-400">{formatMoney(getIncome(selectedBar.id))}<span className="text-xs text-gray-500">/s</span></div>
                                    </div>
                                </div>
                                <button onClick={() => purchaseOrUpgradeBar(selectedBar.id)} disabled={gameState.money < getUpgradeCost(selectedBar.id)} className={`w-full py-4 rounded-lg font-bold text-lg transition-all flex justify-between px-6 items-center ${gameState.money >= getUpgradeCost(selectedBar.id) ? 'bg-blue-600 hover:bg-blue-500 text-white shadow-lg shadow-blue-900/50' : 'bg-gray-700 text-gray-500 cursor-not-allowed'}`}>
                                    <span>{selectedBarState.owned ? "Ausbauen" : "Kaufen"}</span>
                                    <span>{formatMoney(getUpgradeCost(selectedBar.id))}</span>
                                </button>
                                
                                {selectedBarState.owned && (
                                    <button 
                                        onClick={() => upgradeRange(selectedBar.id)} 
                                        disabled={gameState.money < getRangeUpgradeCost(selectedBar.id)}
                                        className={`w-full mt-3 py-3 rounded-lg font-bold text-sm transition-all flex justify-between px-6 items-center
                                            ${gameState.money >= getRangeUpgradeCost(selectedBar.id) 
                                                ? 'bg-purple-600 hover:bg-purple-500 text-white shadow-lg' 
                                                : 'bg-gray-800 text-gray-500 cursor-not-allowed border border-gray-700'}
                                        `}
                                    >
                                        <div className="flex flex-col items-start">
                                            <span>üî≠ Sichtweite +</span>
                                            <span className="text-[10px] font-normal opacity-70">Aktuell: {formatDistance(getRangeRadius(selectedBar.id))}</span>
                                        </div>
                                        <span>{formatMoney(getRangeUpgradeCost(selectedBar.id))}</span>
                                    </button>
                                )}

                                <div className="mt-2 text-center text-xs text-gray-500">N√§chster x2 Boost bei Level {Math.ceil((selectedBarState.level + 1) / 5) * 5}</div>
                            </div>
                        </div>
                    )}

                    <div className={`absolute top-24 left-4 z-20 transition-all duration-300 ${isListOpen ? 'opacity-100 translate-x-0' : 'opacity-0 -translate-x-full pointer-events-none'}`}>
                        <div className="bg-gray-900/90 backdrop-blur border border-gray-700 rounded-xl overflow-hidden shadow-xl w-72 max-h-[70vh] flex flex-col pointer-events-auto">
                            <div className="p-3 border-b border-gray-700 bg-gray-800/50 font-bold text-sm text-gray-300 flex justify-between items-center">
                                <span>Entdeckte Locations</span>
                                <button onClick={() => setIsListOpen(false)} className="text-gray-400 hover:text-white">‚úï</button>
                            </div>
                            <div className="overflow-y-auto flex-1 p-2 space-y-4">
                                {Object.keys(barsByDistrict).sort().map(district => (
                                    <div key={district}>
                                        <div className="text-xs font-bold text-yellow-500 uppercase tracking-widest px-2 mb-1 opacity-70 sticky top-0 bg-gray-900/80 backdrop-blur py-1 z-10">{district}</div>
                                        <div className="space-y-1">
                                            {barsByDistrict[district].map(bar => {
                                                const state = gameState.bars[bar.id] || { owned: false };
                                                const canAfford = gameState.money >= getUpgradeCost(bar.id);
                                                return (
                                                    <div key={bar.id} onClick={() => { setSelectedBarId(bar.id); mapRef.current.setView([bar.lat, bar.lng], 14); if (window.innerWidth < 1024) setIsListOpen(false); }} className={`p-2 rounded cursor-pointer transition-colors border-l-4 ${state.owned ? 'border-green-500 bg-gray-800/50 hover:bg-gray-700' : 'border-red-900 bg-gray-900/30 hover:bg-gray-800'} ${selectedBarId === bar.id ? 'bg-gray-700' : ''}`}>
                                                        <div className="flex justify-between items-center">
                                                            <div className="flex items-center gap-2 overflow-hidden">{canAfford && <span className="text-[10px] animate-bounce">‚¨ÜÔ∏è</span>}<span className="font-medium text-sm truncate">{bar.name}</span></div>
                                                            {state.owned && <span className="text-[10px] bg-green-900 text-green-300 px-1.5 rounded">Lvl {state.level}</span>}
                                                        </div>
                                                        {!state.owned && <div className="text-[10px] text-gray-500 mt-1">Kosten: {formatMoney(bar.baseCost)}</div>}
                                                    </div>
                                                )
                                            })}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
